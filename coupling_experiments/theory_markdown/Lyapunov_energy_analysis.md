# Lyapunov 能量方法分析 G_merge Dominance

---

## 1. 线性系统的 Lyapunov 稳定性理论

### 1.1 基本定理

对于稳定的离散线性系统 $x(t+1) = A \cdot x(t)$，若所有特征值 $|\lambda| < 1$，则：

**存在正定矩阵 $P$ 满足离散 Lyapunov 方程：**
$$A^T P A - P = -Q$$
其中 $Q$ 是任意正定矩阵（通常取 $Q = I$）。

**$V(x) = x^T P x$ 是 Lyapunov 函数：**
$$V(Ax) - V(x) = x^T (A^T P A - P) x = -x^T Q x < 0$$

即能量 **严格递减**！

### 1.2 应用到 Theory 系统

Theory 系统的转移矩阵（以 $l_0=50, l_A=4, l_B=7$ 为例）：

```
A = [[-1.02, -1.04, -1.06, -0.54, -0.55, -0.56,  0   ]
     [ 1   ,  0   ,  0   ,  0   ,  0   ,  0   ,  0   ]
     [ 0   ,  1   ,  0   ,  0   ,  0   ,  0   ,  0   ]
     [ 0   ,  0   ,  1   ,  0   ,  0   ,  0   ,  0   ]
     [ 0   ,  0   ,  0   ,  1   ,  0   ,  0   ,  0   ]
     [ 0   ,  0   ,  0   ,  0   ,  1   ,  0   ,  0   ]
     [ 0   ,  0   ,  0   ,  0   ,  0   ,  1   ,  0   ]]
```

**特征值：** $|\lambda_{max}| = 0.988 < 1$（系统稳定）

**求解 Lyapunov 方程得到正定矩阵 $P$。**

---

## 2. 数值验证结果

### 2.1 能量定义

设稳态 $M^* = [N, N, \ldots, N]$ 其中 $N = B / \sum_s W_s$。

定义能量：
$$V(M) = (M - M^*)^T P (M - M^*)$$

### 2.2 验证结果（200 步）

| 性质 | 结果 |
|:-----|:----:|
| Theory 能量严格递减：$V^T(t+1) < V^T(t)$ | 199/199 ✓ |
| Simulation 能量严格递减：$V^S(t+1) < V^S(t)$ | 199/199 ✓ |
| **Theory 能量 ≥ Simulation 能量：$V^T(t) \geq V^S(t)$** | **200/200 ✓** |

### 2.3 能量比值

| Step | $V^T$ | $V^S$ | $V^T / V^S$ |
|:----:|------:|------:|:-----------:|
| 0 | 9533 | 9533 | 1.00 |
| 10 | 6554 | 4692 | 1.40 |
| 50 | 2936 | 1838 | 1.60 |
| 100 | 1288 | 791 | 1.63 |
| 150 | 565 | 345 | 1.64 |
| 200 | 248 | 151 | 1.64 |

**结论：Simulation 的能量始终低于 Theory，且比值稳定在约 1.6。**

---

## 3. Eviction 的耗散作用

### 3.1 理论分析

当 Theory 需要 admission $a < 0$ 时：
- **Theory**：$M^T_0 = a$（负值）
- **Simulation**：$M^S_0 = 0$，通过 eviction 从某 stage $k$ 移除 tokens

这种 **截断 + eviction** 操作将负值"分散"到两个位置：
- Stage 0 从 $a$ 变为 $0$（减少了 $|a|$）
- Stage $k$ 减少一定量

### 3.2 为什么这会减少能量？

Lyapunov 函数 $V(x) = x^T P x$ 是二次型。

**二次型的性质**：将"偏差"分散到多个方向，通常会减少总能量。

直觉：一个大的负值贡献的能量 > 两个小的负值贡献的能量之和。

### 3.3 Eviction 位置的分析

数值观察：Eviction 主要发生在 **stage 1-3**。

| Stage | Eviction 次数 |
|:-----:|:-------------:|
| 0 | 0 |
| 1 | 7 |
| 2 | 4 |
| 3 | 1 |
| 4-6 | 0 |

**关键发现：**
- Eviction **不发生在 argmax 位置**（只有 3/12 次）
- Eviction **不发生在 argmin 位置**（0/12 次）

这解释了为什么 $m^S$（Simulation 最大值位置）无累积 eviction！

---

## 4. Lyapunov 能量与 Spread $G$ 的关系

### 4.1 问题

已证明 $V^T \geq V^S$，能否推出 $G^T \geq G^S$？

### 4.2 分析

$V$ 和 $G$ 是不同的量：
- $V(x) = x^T P x$ 是加权二次型
- $G(M) = \max M - \min M$ 是 $\ell^\infty$ 范数差

数值检验 $G^2 / V$ 的比值：
- Theory: $0.018 \sim 0.055$
- Simulation: $0.019 \sim 0.060$

比值范围相近，**无法直接从 $V^T \geq V^S$ 推出 $G^T \geq G^S$**。

### 4.3 可能的突破

**尝试 1：选择特殊的 $Q$**

Lyapunov 方程 $A^T P A - P = -Q$ 中，$Q$ 可以任意选择。

能否找到一个 $Q$ 使得 $V$ 与 $G$ 有更直接的关系？

**尝试 2：直接用 $G$ 构造 Lyapunov-like 函数**

定义 $U(M) = G(M)^2 = (\max M - \min M)^2$

需要证明：
1. $U$ 对 Theory 递减
2. Eviction 不增加 $U$

---

## 5. 总结与启示

### 5.1 已证明

1. **Theory 系统稳定**：存在 Lyapunov 函数 $V$，能量严格递减
2. **Simulation 能量也递减**：$V^S(t+1) < V^S(t)$
3. **Eviction 有耗散作用**：$V^T(t) \geq V^S(t)$ 对所有 $t$ 成立

### 5.2 核心直觉

Eviction 的截断操作将"极端值"（负 admission）分散到多个位置，
这在 Lyapunov 能量意义下是一种 **耗散**。

类似地，在 spread $G$ 的意义下，Eviction 也应该有类似的"平滑"作用，
使得 $G^S \leq G^T$。

### 5.3 待解决

找到一个更直接连接 $V$ 和 $G$ 的方法，或者：
- 用 $G$ 本身构造 Lyapunov-like 函数
- 证明 eviction 不增加 spread

---

## 6. 附录：Lyapunov 矩阵 $P$

对于 $l_0=50, l_A=4, l_B=7$ 的参数，$P$ 的特征值：

$$1.0, 3.7, 4.8, 6.0, 14.8, 51.0, 166.6$$

均为正，确认 $P$ 正定。
