# Coupling Experiments 使用说明

## 快速开始

### 1. 配置参数

编辑 `config.json`：

```json
{
    "l0": 1000,      // prefill length
    "l_A": 6,        // Type A decode length
    "l_B": 23,       // Type B decode length
    "B": 10000,      // GPU capacity (tokens)
    "lambda_A": 1.0, // Type A arrival rate
    "lambda_B": 1.0, // Type B arrival rate
    "steps": 10000   // 模拟步数
}
```

### 2. 运行实验

```bash
cd coupling_experiments
python run_coupling_experiment.py
```

### 3. 查看结果

输出在 `outputs/YYYYMMDD_HHMMSS/` 目录：

| 文件 | 说明 |
|------|------|
| `config.json` | 实验配置快照 |
| `trajectory.csv` | 每个 batch 的数据 |
| `comparison.png` | Admission/Eviction 对比 |
| `eviction_detail.png` | Eviction 按 stage 分布 |
| `G_comparison.png` | G (max-min) 对比 |
| `G_decomposed.png` | G 分解图（2×4） |
| `roots_analysis.png` | 特征方程与极限方程根（复平面） |

---

## 参数说明

| 参数 | 含义 | 建议值 |
|------|------|--------|
| `l0` | Prefill length | 100-1000 |
| `l_A`, `l_B` | Decode lengths | 互质（gcd=1）以保证稳定 |
| `B` | GPU capacity | 远大于 l0 |
| `lambda_A`, `lambda_B` | 到达率 | 通常设为 1.0 |
| `steps` | 模拟步数 | 足够观察收敛 |

---

## 输出文件格式

### trajectory.csv 列说明

| 列名 | 说明 |
|------|------|
| `batch` | Batch 序号 |
| `theory_admission` | Theory 的 admission（可负） |
| `sim_admission` | Simulation 的 admission（≥0） |
| `sim_eviction_total` | Simulation 的总 eviction |
| `theory_G`, `sim_G` | 全局 G (max-min) |
| `theory_G_A`, `sim_G_A` | Type A 的 G |
| `theory_G_B`, `sim_G_B` | Type B 的 G |
| `theory_G_merge`, `sim_G_merge` | 合并+补偿的 G |
| `theory_G_merged_raw`, `sim_G_merged_raw` | 合并无补偿的 G |
| `sim_eviction_stage{i}` | 各 stage 的 eviction |

---

## G_decomposed.png 图表说明

2×4 布局：

| | G_A | G_B | G_merge | G_merged_raw |
|---|-----|-----|---------|--------------|
| **上排** | Theory vs Sim | Theory vs Sim | Theory vs Sim | Theory vs Sim |
| **下排** | Δ (差值) | Δ (差值) | Δ (差值) | Δ (差值) |

- 上排：蓝线 = Theory，绿线 = Simulation
- 下排：紫线 = 差值，红点 = 负值

---

## 常见问题

### Q: 为什么 Theory admission 可以是负数？

A: Theory 模拟器不强制非负约束。当 increment_tokens > completion_tokens 时，admission 为负，表示系统需要"借用"未来的 tokens。

### Q: G_merge 和 G_merged_raw 有什么区别？

A:
- `G_merge`：补偿缺失 type 的流量，均衡时趋近 0
- `G_merged_raw`：直接合并，均衡时趋近非零常数

### Q: 如何判断系统是否稳定？

A: 观察 G metrics 是否收敛到接近 0。gcd(l_A, l_B) = 1 时系统稳定。

---

## 扩展

### 修改可视化

编辑 `visualize_coupling.py` 中的相应函数。

### 添加新的 G metric

1. 在 `metrics.py` 中添加新函数
2. 在 `run_coupling_experiment.py` 中计算并添加到 row
3. 在 `visualize_coupling.py` 中添加可视化

---

## roots_analysis.png 图表说明

展示特征方程和极限方程的根在复平面上的分布：

| 类型 | 颜色 | 说明 |
|------|------|------|
| 极限方程根 (\|λ\|=1) | 蓝色 ○ | 单位圆上 |
| 极限方程根 (\|λ\|<1) | 绿色 ○ | 单位圆内 |
| 特征方程根 (\|λ\|>1) | 红色 × | 不稳定根 |
| 特征方程根 (\|λ\|≤1) | 橙色 × | 稳定根 |

**稳定性判断**：gcd(l_A, l_B) = 1 时系统稳定，所有特征方程根在单位圆内。

---

**详细实现细节请参考 [实现细节.md](实现细节.md)**

**根分析理论背景请参考 [第四阶段_特征方程的根的可视化.md](第四阶段_特征方程的根的可视化.md)**
